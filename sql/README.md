# User Key/Value API Relational Database

The user-key-value-api service is supported by a MySQL relational
database.  The schema of this database is not unique for any supported
project (i.e. HuBMAP and SenNet use the same schema and same service
in their individual deployments.) The files in this directory support
the single database model used by all user-key-value-api
microservices.

## User Key/Value API Relational Database files

The sql directory of the user-key-value-api Git repository contains
these core files:
 * `user-key-value-api.mwb` is a [MySQL Workbench](https://www.mysql.com/products/workbench/)
   Model file for maintaining the schema used by user-key-value-api, and
   generating the diagram and DDL SQL of the other two files.
 * `user-key-value-api.pdf` is an Entity-Relationship Diagram for the
   schema, and is *automatically created from the Model using MySQL
   Workbench*.
 * `user-key-value-api.ddl` is a file containing the DDL SQL commands
   for setting up the schema in an existing database, and is
   *created from the Model* using the "forward engineer" feature of
   MySQL Workbench. It should not be directly edited unless the
   `user-key-value-api.mwb` Model is being abandoned.

## MySQL Workbench
All aspects of the model (tables, referential integrity constraints,
indexes, etc.) are maintained in the Model contained in the
`user-key-value-api.mwb` file.  The Model and MySQL Workbench are
generally **_not_** used by the team for database work, but only to
generate the following files.

### `user-key-value-api.pdf` file generation
On the "MySQL Model" tab, double-click the "EER Diagram", if it is not
already open.

Save a copy of the Entity-Relationship Diagram using
````
File | Print to File...
````
Save this file as `user-key-value-api.pdf`.

### `user-key-value-api.ddl` file generation
The "forward engineer" feature of MySQL Workbench is *partially*
executed to generate the DDL SQL commands to populate this file, then
cancelled. However, it is also necessary to make a database connection
to start "forward engineer" process.
````
Database | Forward Engineer...
````
After setting the connection parameters and clicking "Next", check the
following option on the "Options for Database" screen
````
Omit schema qualifier in object names
````
````
Include model attached scripts
````
and uncheck the following option on the same screen
````
Generate USE statements
````
Click "Next", and provide the password when prompted.  On the "Select
Objects" screen, check
````
Export MySQL Table Objects
````
Click "Next".  Examine the generated SQL script to assure it is
independent of the database it is being executed in. For example,
statements should look like

````CREATE TABLE IF NOT EXISTS `user_key_value`...````

and **_not_**

````CREATE TABLE IF NOT EXISTS `hm_user_key_value`.`user_key_value`...````

Use the buttons or clipboard to save this file as `user-key-value-api.ddl`.

Click "Cancel" to abandon the rest of the "forward engineer" process.

## Create as database in which DDL script will execute
A database should be created on the server to receive the DDL commands
generated by "forward engineer."

Ways of creating the database vary by platform (e.g. MySQL Workbench,
dBeaver, mysql AKA the command line client.) The essential command to
run is:
````
CREATE DATABASE `hm_user_key_value`
````
Note the backquotes of this command.  Also decide whether you want to
start with a customized name (like `hm_kbkbkb_user_key_value`), and
how you will manage that if the database will eventually become Dev,
Stage, or Prod.
